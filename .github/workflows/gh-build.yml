name: Build Ardour (Linux x86_64)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    env:
      PREFIX: /usr/local

    steps:
      - name: Checkout code (with full history)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Ardour needs git metadata

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential autoconf automake cmake m4 make \
            git python3 pkg-config gettext intltool itstool yelp-tools \
            bison flex libtool libffi-dev libexpat1-dev libreadline-dev \
            libboost-all-dev libasound2-dev libjack-jackd2-dev libpulse-dev \
            libglib2.0-dev libglibmm-2.4-dev libgtk-3-dev libgtkmm-3.0-dev \
            libsndfile1-dev libarchive-dev liblo-dev libtag1-dev \
            vamp-plugin-sdk librubberband-dev libfftw3-dev libaubio-dev \
            libxml2-dev libsamplerate0-dev lv2-dev libserd-dev libsord-dev \
            libsratom-dev liblilv-dev libwebsockets-dev libusb-1.0-0-dev \
            libpangomm-1.4-dev libcurl4-openssl-dev libcppunit-dev \
            libpango1.0-dev libcairomm-1.0-dev libfontconfig1-dev \
            libfreetype6-dev libfribidi-dev libvorbis-dev libogg-dev \
            libflac-dev libtiff-dev libjpeg-dev libpng-dev \
            libuuid1 uuid-dev zlib1g-dev libx11-dev \
            libnss3-dev libnspr4-dev \
            xsltproc libxml2-utils python3-docutils doxygen

      - name: Configure build
        run: |
          ./waf configure \
            --optimize \
            --ptformat \
            --docs \
            --with-backends=jack,alsa,pulseaudio \
            --freedesktop

      - name: Build Ardour
        run: |
          ./waf -j$(nproc)

      - name: Install to staging
        run: |
          ./waf install --destdir=$GITHUB_WORKSPACE/_install

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ardour-linux-x86_64
          path: _install
